{% extends 'base.html' %}

{% block content %}
<main class="container mt-4">
  <h2>üí≥ Movimientos virtuales</h2>

  <!-- Formulario para agregar varios movimientos virtuales (formset) -->
  <form method="POST" action="{% url 'movimientos_virtuales' %}" id="virtual-form" onsubmit="return submitVirtualForm(event)">
    {% csrf_token %}
    <div class="mb-3">
      <input type="text" name="descripcion_general" class="form-control form-control-sm" placeholder="Descripci√≥n general (opcional)">
    </div>
    <h4>Items</h4>
    <table class="table" id="vitems-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {{ formset.management_form }}
        {% for form in formset.forms %}
        <tr class="item-row">
          <td>{{ form.producto }}</td>
          <td>
            {{ form.cantidad_producto }}
            <script>document.currentScript.previousElementSibling.setAttribute('min','1'); document.currentScript.previousElementSibling.setAttribute('required','required');</script>
          </td>
          <td>{{ form.monto }}</td>
          <td>
            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
            <button type="button" class="btn btn-sm btn-danger remove-line">Quitar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="button" id="add-line-v" class="btn btn-secondary mb-3">Agregar Producto</button>

    <div>
      <strong>Total: $<span id="virtual-total">0.00</span></strong>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Agregar</button>
      <a href="{% url 'inicio' %}" class="btn btn-link">Cancelar</a>
    </div>
  </form>


</main>

<script>
(function(){
  function parseFloatSafe(v){return parseFloat(v)||0}

  async function getProductPrice(productoId){
    try{
      const resp = await fetch(`/get_product_price/${productoId}/`);
      const data = await resp.json();
      return data.precio;
    }catch(e){ console.error('getProductPrice', e); return 0 }
  }

  async function updateMontoForSelect(select){
    const row = select.closest('tr');
    const cantidadInput = row.querySelector('input[name$="-cantidad_producto"]');
    const montoInput = row.querySelector('input[name$="-monto"]');
    const productoId = select.value;
    if(!montoInput) return;
    if(productoId){
      const precio = await getProductPrice(productoId);
      const qty = parseFloatSafe(cantidadInput ? cantidadInput.value : 1);
      montoInput.value = (precio * (qty>0?qty:1)).toFixed(2);
      montoInput.readOnly = true;
    } else {
      montoInput.value = '';
      montoInput.readOnly = false;
    }
    updateTotal();
  }

  function updateTotal(){
    let total = 0;
    document.querySelectorAll('#vitems-table tbody tr.item-row').forEach(function(row){
      // Solo considerar filas visibles
      if (row.style.display !== 'none') {
        const m = parseFloatSafe(row.querySelector('input[name$="-monto"]').value);
        total += m;
      }
    });
    document.getElementById('virtual-total').innerText = total.toFixed(2);
    
    // Habilitar/deshabilitar el bot√≥n de submit basado en la validez
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
      const hasValidProducts = document.querySelectorAll('#vitems-table tbody tr.item-row:not([style*="display: none"])').length > 0;
      const hasPositiveTotal = total > 0;
      submitBtn.disabled = !hasValidProducts || !hasPositiveTotal;
    }
  }

  document.addEventListener('change', function(e){
    const el = e.target;
    if(!el) return;
    if(el.tagName.toLowerCase()==='select' && /-producto$/.test(el.name)){
      updateMontoForSelect(el);
    }
  });

  document.addEventListener('input', function(e){
    // recalc total when monto or cantidad change
    if(e.target && (/-monto$/.test(e.target.name) || /-cantidad_producto$/.test(e.target.name))){
      // if quantity changed and product selected, update monto accordingly
      const row = e.target.closest('tr');
      if(row){
        const sel = row.querySelector('select[name$="-producto"]');
        if(sel && sel.value){ updateMontoForSelect(sel); return }
      }
      updateTotal();
    }
  });

  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-line')){
      const row = e.target.closest('tr');
      if (!row) return;
      
      // Solo permitir eliminar si hay m√°s de una fila visible
      const visibleRows = document.querySelectorAll('#vitems-table tbody tr.item-row:not([style*="display: none"])')
      if (visibleRows.length <= 1) {
        alert('Debe haber al menos un producto en el movimiento')
        return
      }

      const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if(del){ 
        del.checked = true; 
        row.style.display='none'; 
        updateTotal(); 
        return 
      }
      row.remove();
      updateTotal();
      
      // Validar que quede al menos una fila despu√©s de eliminar
      setTimeout(() => {
        const remainingRows = document.querySelectorAll('#vitems-table tbody tr.item-row:not([style*="display: none"])')
        if (remainingRows.length === 0) {
          document.getElementById('add-line-v').click()
        }
      }, 0)
    }
  });

  document.getElementById('add-line-v').addEventListener('click', function(){
    const tbody = document.querySelector('#vitems-table tbody');
    const last = tbody.querySelector('tr.item-row:last-of-type');
    if(!last) return;
    const clone = last.cloneNode(true);
    // clear values
    clone.querySelectorAll('input, select').forEach(function(i){
      if(i.tagName.toLowerCase()==='select') i.selectedIndex=0;
      if(i.type==='number' || i.type==='text') i.value='';
    });
    // increment TOTAL_FORMS
    const totalForms = document.querySelector('#id_vitems-TOTAL_FORMS');
    if(totalForms){
      const idx = parseInt(totalForms.value);
      clone.querySelectorAll('[name]').forEach(function(el){
        const name = el.getAttribute('name');
        const newName = name.replace(/-\d+-/, '-' + idx + '-');
        el.setAttribute('name', newName);
        const id = el.getAttribute('id'); if(id) el.setAttribute('id', id.replace(/-\d+-/, '-' + idx + '-'));
      });
      totalForms.value = idx + 1;
    }
    tbody.appendChild(clone);
  });

  // initialize totals for existing rows
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('select[name$="-producto"]').forEach(function(s){ if(s.value) updateMontoForSelect(s) });
    
    // Asegurarse que siempre haya al menos una fila al inicio
    setTimeout(() => {
      const rows = document.querySelectorAll('#vitems-table tbody tr.item-row:not([style*="display: none"])')
      if (rows.length === 0) {
        document.getElementById('add-line-v').click()
      }
    }, 0)
    
    updateTotal();
  });

})();
</script>

<script>
// Env√≠o AJAX del formulario y cierre de popup al agregar
async function submitVirtualForm(event){
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  try{
    const resp = await fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'same-origin'
    });
    const data = await resp.json();
    if(data.success){
      if(window.opener){
        window.opener.location.reload();
      }
      window.close();
    } else {
      alert('Error: ' + (data.message || 'Error desconocido'));
    }
  }catch(err){
    console.error('Error enviando formulario virtual:', err);
    alert('Error al procesar el formulario. Revis√° la consola.');
  }
  return false;
}
</script>

{% endblock %}
